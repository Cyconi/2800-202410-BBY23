<%- include("template/header") %>

    <div class="container text-center">
        <h1 id="queueHeader">Waiting In Queue... <span class="queueCount">
                <%= queueCount %>
            </span></h1>
        <div class="row center-screen">
            <div class="col-md-4">
                <form action='/chat/join' method='POST'>
                    <button type="submit" class="btn btn-primary">Join Queue</button>
                </form>
                <br>
                <form action='/chat/leave' method='POST'>
                    <button type="submit" class="btn btn-primary">Leave Queue</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        // trigger the leave queue when page is unloaded. 
        // Currantly theres an issue where leave/join causes the page to reload making this not function properly
        window.addEventListener('beforeunload', function () {
            navigator.sendBeacon('/chat/leave');
        });
        //    function getQueue() {
        //         fetch('/chat/updateQueue', { method: 'POST' })
        //             .then(response => response.json())
        //             .then(data => {
        //                 if (data.success) {
        //                     document.querySelector('.queueCount').textContent = data.queueCount;
        //                 }
        //             })
        //             .catch(error => {
        //                 console.error('Error checking queue:', error);
        //                 setTimeout(getQueue, 5000);
        //             });
        //     }
        //     setTimeout(getQueue, 3000);

        function getQueue() {
            $.get('/chat/updateQueue', function (data) {
                if (data.success) {
                    document.querySelector('.queueCount').textContent = data.queueCount;
                }
            }).fail(function (error) {
                console.error('Error checking queue:', error);
                setTimeout(getQueue, 5000);
            });
        }
        function matchFound() {
            $.get('/chat/matchFound', function (data) {
                if (data.success) {
                    console.log('Match found! Joining chatroom...');
                    window.location.href = data.redirectTo;
                }
            });
        }

        $(document).ready(function () {
            getQueue(); // Check the queue when the page loads
            setInterval(getQueue, 3000); // Check the queue every 3 seconds
            matchFound();
            setInterval(matchFound, 3000);
        });

    </script>
    <%- include("template/footer") %>